<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      background: #000;
      color: white;
    }

    #progress-bar {
      margin-top: 1em;
      width: 100vw;
      height: 1em;
      background: red;
      transition: 0.3s;
    }
  </style>
</head>
<body>

  <!-- https://www.digitalocean.com/community/tutorials/js-file-reader  -->


  <input type="file" id="input" />
  <progress value="0" max="100" id="progress-bar"></progress>
  <div id="status"></div>
  <script>
  
	var fileName = null;
  
    const changeStatus = (status) => {
      document.getElementById('status').innerHTML = status;
    }

    const setProgress = (e) => {
      const fr = e.target;
      const loadingPercentage = 100 * e.loaded / e.total;

      document.getElementById('progress-bar').value = loadingPercentage;
    }

	  const loaded = (e) => {
      const fr = e.target;
	  console.log(e.target);
      var inputBuffer = fr.result;
      changeStatus('Finished Loading!');
      console.log('Result:', inputBuffer);
	  
	  // the file-content is now read as "byte"-Array into the variable "inputBuffer"
	  
	  // then we could
	  // 1. encrypt the array
	  // 2. upload to server as 'application/octet-stream'
	  
	  // later we could
	  // 1. download from server as 'application/octet-stream'
	  // 2. decrypt the array

	  // 3. save array to local filesystem with "downloadblob"
	  	   
	  // (reading filename from global variable ... just a workaround)
	  downloadBlob(inputBuffer, fileName, 'application/octet-stream');	  
    }
	
    const errorHandler = (e) => {
      changeStatus('Error: ' + e.target.error.name);
    }

    const processFile = (file) => {
      const fr = new FileReader();
	  
	  // saving filename to global variable ... just a workaround
	  fileName = file.name;	
	  
      console.log(file.name);
      fr.readAsArrayBuffer(file);
      fr.addEventListener('loadstart', changeStatus('Start Loading'));
      fr.addEventListener('load', changeStatus('Loaded'));
      fr.addEventListener('loadend', loaded);
      fr.addEventListener('progress', setProgress);
      fr.addEventListener('error', errorHandler);
      fr.addEventListener('abort', changeStatus('Interrupted'));
    }

    document.getElementById('input').addEventListener('change', (e) => {
      const file = document.getElementById('input').files[0];

      if (file) {
        processFile(file);
      }
    });
	
	
	
	
	downloadBlob = function(data, fileName, mimeType) {
      var blob, url;
      blob = new Blob([data], {
      type: mimeType
      });
      url = window.URL.createObjectURL(blob);
      downloadURL(url, fileName);
      setTimeout(function() {
        return window.URL.revokeObjectURL(url);
      }, 1000);
    };

    downloadURL = function(data, fileName) {
      var a;
      a = document.createElement('a');
      a.href = data;
      a.download = fileName;
      document.body.appendChild(a);
      a.style = 'display: none';
      a.click();
      a.remove();
    };
	
  </script>
</body>
</html>